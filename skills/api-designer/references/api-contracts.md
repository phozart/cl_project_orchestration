# API Contracts Guide

How to generate binding API contracts that developers MUST use.

---

## Why API Contracts

Without contracts:
```
OpenAPI: getUsers
Developer A: fetchUsers()
Developer B: getAllUsers()
Developer C: listUsers()
```

With contracts:
```
API-CONTRACTS.ts defines: getUsers()
ALL developers use: getUsers()
```

---

## Contract File Structure

```typescript
// docs/api/API-CONTRACTS.ts

/**
 * API CLIENT CONTRACTS
 * operationId = function name (exactly)
 * Generated by: api-designer
 * Used by: fullstack-developer
 */

import {
  User,
  CreateUserDTO,
  UpdateUserDTO,
  UserResponse
} from '../data/TYPE-CONTRACTS';

// ============================================
// Users API
// Base: /api/v1/users
// ============================================

// GET /api/v1/users
// operationId: getUsers
export interface GetUsersRequest {
  page?: number;
  limit?: number;
  status?: 'active' | 'inactive';
  role?: string;
  search?: string;
}

export interface GetUsersResponse {
  data: UserResponse[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
}

// GET /api/v1/users/:id
// operationId: getUserById
export interface GetUserByIdRequest {
  id: string;
}

export interface GetUserByIdResponse {
  data: UserResponse;
}

// POST /api/v1/users
// operationId: createUser
export interface CreateUserRequest {
  body: CreateUserDTO;
}

export interface CreateUserResponse {
  data: UserResponse;
}

// PUT /api/v1/users/:id
// operationId: updateUser
export interface UpdateUserRequest {
  id: string;
  body: UpdateUserDTO;
}

export interface UpdateUserResponse {
  data: UserResponse;
}

// DELETE /api/v1/users/:id
// operationId: deleteUser
export interface DeleteUserRequest {
  id: string;
}

export interface DeleteUserResponse {
  success: boolean;
  message: string;
}

// ============================================
// API Client Interface
// ============================================

export interface ApiClient {
  // Users
  getUsers(req: GetUsersRequest): Promise<GetUsersResponse>;
  getUserById(req: GetUserByIdRequest): Promise<GetUserByIdResponse>;
  createUser(req: CreateUserRequest): Promise<CreateUserResponse>;
  updateUser(req: UpdateUserRequest): Promise<UpdateUserResponse>;
  deleteUser(req: DeleteUserRequest): Promise<DeleteUserResponse>;
}

// ============================================
// Error Types
// ============================================

export interface ApiError {
  code: string;
  message: string;
  details?: Array<{
    field: string;
    message: string;
  }>;
  requestId?: string;
}

export type ApiErrorCode =
  | 'VALIDATION_ERROR'
  | 'UNAUTHORIZED'
  | 'FORBIDDEN'
  | 'NOT_FOUND'
  | 'CONFLICT'
  | 'RATE_LIMITED'
  | 'INTERNAL_ERROR';
```

---

## OpenAPI operationId Mapping

Every endpoint MUST have operationId:

```yaml
paths:
  /users:
    get:
      operationId: getUsers       # → function getUsers()
      summary: List all users
    post:
      operationId: createUser     # → function createUser()
      summary: Create a new user

  /users/{id}:
    get:
      operationId: getUserById    # → function getUserById()
    put:
      operationId: updateUser     # → function updateUser()
    delete:
      operationId: deleteUser     # → function deleteUser()
```

---

## Naming Convention Rules

| Operation | Pattern | Example |
|-----------|---------|---------|
| List | get{Resource}s | getUsers |
| Get one | get{Resource}ById | getUserById |
| Create | create{Resource} | createUser |
| Update (full) | update{Resource} | updateUser |
| Update (partial) | patch{Resource} | patchUser |
| Delete | delete{Resource} | deleteUser |
| Search | search{Resource}s | searchUsers |
| Custom action | {verb}{Resource} | activateUser |

---

## Required Sections

Every API-CONTRACTS.ts MUST have:

1. **Import from TYPE-CONTRACTS** for entity types
2. **Request interface** for each endpoint
3. **Response interface** for each endpoint
4. **ApiClient interface** listing all operations
5. **Error types** for error handling

---

## Validation Checklist

Before handoff:

- [ ] Every endpoint has operationId in OpenAPI
- [ ] Every operationId has Request/Response interfaces
- [ ] ApiClient interface lists all operations
- [ ] Imports entity types from TYPE-CONTRACTS.ts
- [ ] Error response types defined
- [ ] Pagination types for list endpoints

---

## Developer Usage

Developer MUST:

```typescript
// 1. Import from API contracts
import {
  ApiClient,
  GetUsersRequest,
  GetUsersResponse
} from '@/api/contracts';

// 2. Implement client using exact function names
class ApiClientImpl implements ApiClient {
  async getUsers(req: GetUsersRequest): Promise<GetUsersResponse> {
    return fetch('/api/v1/users?' + new URLSearchParams(req));
  }

  // ... implement all methods from interface
}

// 3. Use typed requests/responses everywhere
const response = await apiClient.getUsers({ page: 1, limit: 20 });
const users = response.data;
```

---

## Contract Update Protocol

When contracts need to change:

1. Developer finds endpoint missing or wrong
2. Developer reports to api-designer (not adds untyped endpoint)
3. Api-designer updates OpenAPI spec
4. Api-designer updates API-CONTRACTS.ts
5. Developer re-imports updated contracts

**NEVER build untyped API calls. Fix the contract.**
